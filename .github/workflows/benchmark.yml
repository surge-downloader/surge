name: Benchmark

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Run Benchmark
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Current Code
        uses: actions/checkout@v4
        with:
          path: current

      - name: Checkout Main Branch (Baseline)
        uses: actions/checkout@v4
        with:
          ref: main
          path: baseline

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.4+auto"
          cache-dependency-path: current/go.sum

      - name: Update APT
        run: sudo apt-get update

      - name: Install Aria2
        run: sudo apt-get install -y aria2

      - name: Install speedtest-cli
        run: sudo apt-get install -y speedtest-cli

      - name: Build Current
        run: |
          cd current
          go build -o ../surge-current .

      - name: Build Baseline
        run: |
          cd baseline
          go build -o ../surge-baseline .

      - name: Download Motrix Assets
        run: |
          mkdir -p current/benchmark
          # Download custom aria2c binary (supports >16 connections)
          curl -L -o current/benchmark/aria2c https://raw.githubusercontent.com/agalwood/Motrix/master/extra/linux/x64/engine/aria2c
          chmod +x current/benchmark/aria2c
          
          # Download Motrix config
          curl -L -o current/benchmark/aria2.conf https://raw.githubusercontent.com/agalwood/Motrix/master/extra/linux/x64/engine/aria2.conf

      - name: Run Benchmark
        id: benchmark
        run: |
          cd current
          # Run benchmark and capture output to both console and file
          python3 benchmark.py --surge-exec ../surge-current --motrix --aria2 --speedtest -n 5 | tee benchmark_output.txt

          # Read file content into environment variable for next step (handling multiline)
          echo "BENCHMARK_RESULTS<<EOF" >> $GITHUB_ENV
          cat benchmark_output.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Also write to Job Summary (visible in Actions tab)
          echo "## ðŸš€ Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat benchmark_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
